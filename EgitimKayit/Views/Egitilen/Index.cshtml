@model EgitimKayit.ViewModels.EgitilenIndexViewModel

@{
    ViewData["Title"] = "Eğitim Katılımcıları";
    var currentUserTip = Context.Session.GetString("PersonelTip");
    var isYetkili = currentUserTip == "talepci" || currentUserTip == "ogretmen" ||
                   currentUserTip == "sorumlu" || currentUserTip == "yonetici";
}

<div class="container-fluid">
    <!-- Başlık ve Eğitim Bilgileri -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Eğitim Katılımcıları</h2>
            @if (Model.EgitimProgram != null)
            {
                <p class="text-muted mb-0">
                    <strong>Eğitim:</strong> @Model.EgitimProgram.EgitimSablon?.Ad |
                    <strong>Dershane:</strong> @Model.EgitimProgram.EgitimSablon?.Dershane?.Ad |
                    <strong>Tip:</strong> @Model.EgitimProgram.EgitimSablon?.EgitimTip?.Ad
                </p>
                <p class="text-muted">
                    @if (Model.EgitimProgram.BasTar.HasValue && Model.EgitimProgram.BitTar.HasValue)
                    {
                        <strong>Tarih:</strong> 
                        @Model.EgitimProgram.BasTar.Value.ToString("dd.MM.yyyy")
                        @Model.EgitimProgram.BitTar.Value.ToString("dd.MM.yyyy")
                                    }
                </p>
            }
        </div>
        <div>
            <a href="@Url.Action("Index", "EgitimProgram")" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Eğitim Programlarına Dön
            </a>
        </div>
    </div>

    <!-- Mesajlar -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- İşlem Butonları -->
    @if (isYetkili)
    {
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="@Url.Action("Create", "Egitilen", new { egitimProgramId = Model.EgitimProgramId })"
                       class="btn btn-primary">
                        <i class="bi bi-person-plus"></i> Tek Personel Ekle
                    </a>
                    <a href="@Url.Action("CreateMultiple", "Egitilen", new { egitimProgramId = Model.EgitimProgramId })"
                       class="btn btn-success">
                        <i class="bi bi-people"></i> Toplu Personel Ekle
                    </a>
                    <a href="@Url.Action("ExcelUpload", "Egitilen", new { egitimProgramId = Model.EgitimProgramId })"
                       class="btn btn-info">
                        <i class="bi bi-file-earmark-excel"></i> Excel'den Yükle
                    </a>
                    <a href="@Url.Action("ExportExcel", "Egitilen", new { egitimProgramId = Model.EgitimProgramId })"
                       class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Excel'e Aktar
                    </a>
                    *
                    <form id="excelUploadForm" method="post" enctype="multipart/form-data" asp-controller="Egitilen" asp-action="ExcelUpload">
                        @Html.AntiForgeryToken()  <!-- çok önemli: POST için -->
                        <input type="hidden" name="EgitimProgramId" value="@Model.EgitimProgramId" />
                        <input type="file" id="excelFileInput" name="ExcelFile" accept=".xlsx,.xls" style="display:none" />
                    </form>

                    <a href="javascript:void(0);" class="btn btn-info" onclick="document.getElementById('excelFileInput').click();">
                        <i class="bi bi-file-earmark-excel"></i> Excel'den Yükle
                    </a>

                    <script>
                        document.getElementById('excelFileInput').addEventListener('change', function () {
                            if (this.files.length > 0) {
                                // otomatik submit (B1 akışı)
                                document.getElementById('excelUploadForm').submit();
                            }
                        });
                    </script>
                    *
                </div>
            </div>
        </div>
    }

    <!-- Katılımcı Listesi -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Katılımcı Listesi</h5>
        </div>
        <div class="card-body">
            @if (!Model.Egitilenler.Any())
            {
                <div class="text-center py-4">
                    <p class="text-muted">Henüz katılımcı bulunmamaktadır.</p>
                    @if (isYetkili)
                    {
                        <a href="@Url.Action("Create", "Egitilen", new { egitimProgramId = Model.EgitimProgramId })"
                           class="btn btn-primary">İlk Katılımcıyı Ekle</a>
                    }
                </div>
            }
            else
            {
                <form id="__AjaxAntiForgeryForm">@Html.AntiForgeryToken()</form>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>TC Kimlik No</th>
                                <th>Ad Soyad</th>
                                <th>Statü</th>
                                <th>Birim</th>
                                <th>Dk</th>
                                <th>Yapıldı</th>
                                <th>Ekleme Tarihi</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var katilimci in Model.Egitilenler)
                            {
                                <tr data-id="@katilimci.Id">
                                    <td>@katilimci.Katilimci?.Tc</td>
                                    <td><strong>@katilimci.Katilimci?.Adlar</strong></td>
                                    <td>@katilimci.Katilimci?.StatuBilgi?.Anlam</td>
                                    <td>@(!string.IsNullOrEmpty(katilimci.Katilimci?.Birim1) ? katilimci.Katilimci.Birim1 : "-")</td>

                                    <td>
                                        <input type="number" class="form-control dk-input" value="@katilimci.Dk" step="5" />
                                    </td>

                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input yapildi-input" @(katilimci.Yapildi == 1 ? "checked" : "") />
                                    </td>

                                    <td>@katilimci.Tarih?.ToString("dd.MM.yyyy HH:mm")</td>

                                    <td>
                                        <button class="btn btn-sm btn-primary kaydet-btn">Kaydet</button>
                                        <span class="ms-2 result-msg"></span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- (Özet Kartları buraya dokunulmadı, senin kodunla aynı kalıyor) -->
                @* Özet bilgileri değiştirmedim, diğer mesajda istersen AJAX ile eş zamanlı güncelleme de eklerim *@
            }
        </div>
    </div>

    @section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", function () {

                document.querySelectorAll(".kaydet-btn").forEach(btn => {
                    btn.addEventListener("click", async function (e) {
                        e.preventDefault();

                        const row = this.closest("tr");
                        const id = row.getAttribute("data-id");
                        const dk = row.querySelector(".dk-input").value;
                        const yapildi = row.querySelector(".yapildi-input").checked;
                        const msgSpan = row.querySelector(".result-msg");

                        msgSpan.textContent = ""; // temizle

                        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                        const response = await fetch('@Url.Action("SatirKaydet", "Egitilen")', {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "RequestVerificationToken": token
                            },
                            body: JSON.stringify({ id, dk, yapildi })
                        });

                        const result = await response.json();

                        if (result.success) {
                            msgSpan.style.color = "green";
                            msgSpan.textContent = "✔ " + result.message;
                        }
                        else {
                            msgSpan.style.color = "red";
                            msgSpan.textContent = "❌ " + result.message;
                        }
                    });
                });

            });
        </script>
    }

</div>